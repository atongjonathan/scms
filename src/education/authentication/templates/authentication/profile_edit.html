{% extends "app/layout.html" %}
{% load i18n static %}

{% block title %}
  {% if form.errors %}
    {% translate "Error:" %} 
  {% endif %}
  {{ block.super }}
{% endblock %}

{% block page %}
<nord-header slot="header">
  <h1 class="n-typescale-l">{{ title }}</h1>
</nord-header>

<nord-stack class="n-padding-m">
    <form method="post" enctype="multipart/form-data">

    <nord-card padding="l">
      <div class="n-grid-2">
        {% csrf_token %}
        <div class="n-stack">

          <nord-input 
              name="first_name" 
              label="First Name" 
              value="{{ form.first_name.value|default:'' }}"   
              error="{% if form.first_name.errors %}
              {{ form.first_name.errors.0 }}         
            {% endif %}"  
              required          
              expand>
          </nord-input>

          <nord-input 
              name="middle_name" 
              label="Middle Name" 
              value="{{ form.middle_name.value|default:'' }}"  
              error="{% if form.middle_name.errors %}
              {{ form.middle_name.errors.0 }}         
            {% endif %}"             
              expand>
          </nord-input>

          <nord-input 
              name="last_name" 
              label="Last Name" 
              value="{{ form.last_name.value|default:'' }}" 
              error="{% if form.last_name.errors %}
              {{ form.last_name.errors.0 }}         
            {% endif %}"              
              expand>
          </nord-input>
        </div>

        <div class="n-stack">
          <nord-input 
              name="mobile_number" 
              label="Mobile Number" 
              value="{{ form.mobile_number.value|default:'' }}" 
              disallow-pattern="[^0-9]"    
              error="{% if form.mobile_number.errors %}
              {{ form.mobile_number.errors.0 }}         
            {% endif %}"           
              expand>
          </nord-input>

  

          {% if object.user_image %}
          <div id="existing-image-section">
            <nord-input 
                name="user_image_display" 
                label="Current Profile Picture" 
                value="{{ object.user_image.url }}" 
                readonly 
                expand
                {% if form.user_image.errors %}
                error="{{ form.user_image.errors.0 }}"     
              {% endif %}>
                <nord-icon slot="start" name="interface-link"></nord-icon>
                <nord-button slot="end" type="button" onclick="clearImage()">Clear</nord-button>
            </nord-input>
          </div>
          <div id="upload-new-image-section" style="display: none;">
        {% else %}
            <div id="upload-new-image-section">
        {% endif %}
                <nord-fieldset label="Profile Picture" error="{% if form.user_image.errors %}
                {{ form.user_image.errors.0 }}         
              {% endif %}">
                  <nord-stack direction="horizontal" wrap>
                    <nord-button 
                    type="button" 
                    variant="secondary" 
                    onclick="document.getElementById('real-file-input').click();">
                    <nord-icon slot="start" name="interface-link"></nord-icon>
                  Attach
                  </nord-button>
                  <p id="selected-file-name" class="pt-2 n-color-text-link underline my-auto"></p>
                  </nord-stack>             

                </nord-fieldset>
            </div>
          </div>

          <input type="file" name="user_image" hidden id="real-file-input" accept="image/*" onchange="handleFileSelected(this)">
          <input type="checkbox" name="clear_user_image" hidden>

    </div>
    <nord-button-group slot="footer" variant="spaced" class="flex justify-end">
      <nord-button href="{% url 'profile' user.email %}" expand>
        Discard
      </nord-button>
      <nord-button type="submit" expand variant="primary">
        Update Profile
      </nord-button>
    </nord-button-group>     
    </nord-card>
  </form>
</nord-stack>


<script>
  function handleFileSelected(input) {
    const fileName = input.files.length ? input.files[0].name : 'No file selected';
    document.getElementById('selected-file-name').textContent = fileName;
    
    // If user selects a new file, ensure the clear checkbox is unchecked
    document.querySelector('input[name="clear_user_image"]').checked = false;
  }

  function clearImage() {
    // Clear the file input (reset the form field)
    const fileInput = document.getElementById('real-file-input');
    fileInput.value = ''; // this clears the file input

    // Mark the clear checkbox
    document.querySelector('input[name="clear_user_image"]').checked = true;

    // Clear the preview text
    document.getElementById('selected-file-name').textContent = 'Image removed';

    // Optional: hide the nord-input with image info, show the attach button
    document.getElementById('existing-image-section').style.display = 'none';
    document.getElementById('upload-new-image-section').style.display = 'block';
  }
</script>


{% endblock %}
